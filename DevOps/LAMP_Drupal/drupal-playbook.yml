- hosts: all
  sudo: yes
  
  vars_files:
  - vars.yml

  pre_tasks:
  - name: Update apt cache if required
    apt: update_cache=yes cache_valid_time=10800

  # --force-handlers key may be used to always run handlers even if task failed
  handlers:
  - name: restart apache
    service: name=apache2 state=restarted

  tasks:
  - name: Install packages for repository management
    apt: name={{ item }} state=installed
    with_items: 
      - python-apt
      - python-pycurl

  - name: Install Apache, MySQL, PHP, and other dependencies.
    apt: name={{ item }} state=installed
    with_items: 
    - git
    - curl
    - sendmail
    - apache2
    - php5
    - php5-common
    - php5-mysql
    - php5-cli
    - php5-gd
    - php5-dev
    - php5-mcrypt
    - php-apc
    - php-pear
    - python-mysqldb
    - mysql-server

  # If on a production server or any server exposed to the Internet, 
  # you should instead have a restrictive firewall only allowing access on
  # ports 22, 80, 443, and other necessary ports.
  - name: Disable firewall (Dev Environment)
    service: name=ufw state=stopped

  - name: Start Apace, MySQL, and PHP
    service: name={{ item }} state=started enabled=yes
    with_items: 
       - apache2
       - mysql

  - name: Enable rewrite module for Drupal
    apache2_module: name=rewrite state=present
    notify: restart apache

  - name: Add Apache virtualhost
    template:
      src: "templates/drupal.dev.conf.j2"
      dest: "/etc/apache2/sites-available/{{ domain }}.dev.conf"
      owner: root
      group: root
      mode: 0644
    notify: restart apache

  - name: Symlink virtualhost
    file:
      src: "/etc/apache2/sites-available/{{ domain }}.dev.conf"
      dest: "/etc/apache2/sites-enabled/{{ domain }}.dev.conf"
      state: link
    notify: restart apache

  - name: remove default virtualhost
    file:
      path: "/etc/apache2/sites-enabled/000-default"
      state: absent
    notify: restart apache